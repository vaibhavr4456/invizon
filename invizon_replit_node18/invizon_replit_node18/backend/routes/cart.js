const express = require('express'); const router = express.Router(); const db = require('../db'); const { nanoid } = require('nanoid'); const { auth } = require('./auth'); router.get('/', auth, (req,res)=>{ const sql = 'SELECT c.id, c.product_id, c.qty, p.title, p.price, p.currency, p.store, p.images, p.external_url, p.checkout_url FROM cart c LEFT JOIN products p ON p.id = c.product_id WHERE c.user_id = ?'; db.all(sql,[req.user.id], (err,rows)=>{ if(err) return res.status(500).json({error:'db'}); rows.forEach(r=> r.images = JSON.parse(r.images||'[]')); res.json(rows); }); }); router.post('/', auth, (req,res)=>{ const { product_id, qty=1 } = req.body; if(!product_id) return res.status(400).json({error:'product_id required'}); db.get('SELECT * FROM cart WHERE user_id=? AND product_id=?',[req.user.id, product_id], (err,row)=>{ if(err) return res.status(500).json({error:'db'}); if(row){ db.run('UPDATE cart SET qty = qty + ? WHERE id = ?',[qty,row.id], function(e){ if(e) return res.status(500).json({error:'db'}); return db.all('SELECT c.id, c.product_id, c.qty, p.title, p.price, p.currency, p.store, p.images, p.external_url, p.checkout_url FROM cart c LEFT JOIN products p ON p.id = c.product_id WHERE c.user_id = ?',[req.user.id], (err2,rows)=>{ rows.forEach(r=> r.images = JSON.parse(r.images||'[]')); res.json(rows); }); }); } else { const id = nanoid(); db.run('INSERT INTO cart (id,user_id,product_id,qty) VALUES (?,?,?,?)',[id,req.user.id,product_id,qty], function(e){ if(e) return res.status(500).json({error:'db'}); db.all('SELECT c.id, c.product_id, c.qty, p.title, p.price, p.currency, p.store, p.images, p.external_url, p.checkout_url FROM cart c LEFT JOIN products p ON p.id = c.product_id WHERE c.user_id = ?',[req.user.id], (err2,rows)=>{ rows.forEach(r=> r.images = JSON.parse(r.images||'[]')); res.json(rows); }); }); } }); }); router.delete('/:id', auth, (req,res)=>{ db.run('DELETE FROM cart WHERE id=? AND user_id=?',[req.params.id, req.user.id], function(err){ if(err) return res.status(500).json({error:'db'}); res.json({success:true}); }); }); module.exports = router;
