const express = require('express'); const router = express.Router(); const db = require('../db'); const bcrypt = require('bcryptjs'); const jwt = require('jsonwebtoken'); const { nanoid } = require('nanoid'); const JWT_SECRET = process.env.JWT_SECRET || 'invizon_secret'; function runAsync(sql, params=[]) { return new Promise((res,rej)=> db.run(sql, params, function(err){ if(err) rej(err); else res(this); })); } function getAsync(sql, params=[]) { return new Promise((res,rej)=> db.get(sql, params, (err,row)=> err?rej(err):res(row))); } router.post('/register', async (req,res)=>{ const {username,email,password} = req.body; if(!email||!password) return res.status(400).json({error:'email & password required'}); const exists = await getAsync('SELECT * FROM users WHERE email=?',[email]); if(exists) return res.status(400).json({error:'Email in use'}); const hash = bcrypt.hashSync(password,8); const id = nanoid(); await runAsync('INSERT INTO users (id,username,email,password_hash) VALUES (?,?,?,?)',[id,username||email.split('@')[0],email,hash]); const token = jwt.sign({id,email},JWT_SECRET,{expiresIn:'7d'}); res.json({token,user:{id,username:username||email.split('@')[0],email}}); }); router.post('/login', async (req,res)=>{ const {email,password} = req.body; if(!email||!password) return res.status(400).json({error:'email & password required'}); const user = await getAsync('SELECT * FROM users WHERE email=?',[email]); if(!user) return res.status(400).json({error:'Invalid credentials'}); const ok = bcrypt.compareSync(password, user.password_hash); if(!ok) return res.status(400).json({error:'Invalid credentials'}); const token = jwt.sign({id:user.id,email:user.email},JWT_SECRET,{expiresIn:'7d'}); res.json({token,user:{id:user.id,username:user.username,email:user.email}}); }); function auth(req,res,next){ const h = req.headers.authorization; if(!h) return res.status(401).json({error:'Missing token'}); const t = h.split(' ')[1]; try{ const data = jwt.verify(t,JWT_SECRET); req.user = data; next(); }catch(e){ return res.status(401).json({error:'Invalid token'}); }} router.get('/me', auth, async (req,res)=>{ const user = await getAsync('SELECT id,username,email FROM users WHERE id=?',[req.user.id]); res.json(user); }); module.exports = router;
